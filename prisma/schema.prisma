generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                  String               @id @default(cuid())
  email               String?
  name                String
  phone               String?
  password            String?
  dateOfBirth         DateTime?
  age                 Int?
  jurisdiction        String               @default("LOCAL")
  role                String?              // Add role field
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt
  adminProfile        Admin?
  karobariAdminProfile KarobariAdmin?
  karobariCandidates  KarobariCandidate[]
  trusteeCandidates   TrusteeCandidate[]
  voterProfile        Voter?
  yuvaPankhCandidates YuvaPankhCandidate[]
  uploadedFiles       UploadedFile[]

  @@index([email])
  @@index([phone])
  @@index([createdAt])
  @@map("users")
}

model Admin {
  id        String   @id @default(cuid())
  userId    String   @unique
  adminId   String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([adminId])
  @@map("admins")
}

model KarobariAdmin {
  id        String   @id @default(cuid())
  userId    String   @unique
  adminId   String   @unique
  name      String
  email     String   @unique
  phone     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([adminId])
  @@index([email])
  @@map("karobari_admins")
}

model Voter {
  id                String    @id @default(cuid())
  userId            String?   @unique
  voterId           String    @unique
  region            String
  hasVoted          Boolean   @default(false)
  lastLoginAt       DateTime?
  zoneId            String?   // Keep for backward compatibility
  yuvaPankZoneId    String?   // Zone for Yuva Pank elections
  karobariZoneId    String?   // Zone for Karobari Members elections
  trusteeZoneId     String?   // Zone for Trustees elections
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  age               Int?
  dob               String?
  email             String?
  gender            String?
  isActive          Boolean   @default(true)
  mulgam            String?
  name              String
  phone             String?
  user              User?     @relation(fields: [userId], references: [id], onDelete: Cascade)
  zone              Zone?     @relation(fields: [zoneId], references: [id])
  yuvaPankZone      Zone?     @relation("VoterYuvaPankZone", fields: [yuvaPankZoneId], references: [id])
  karobariZone      Zone?     @relation("VoterKarobariZone", fields: [karobariZoneId], references: [id])
  trusteeZone       Zone?     @relation("VoterTrusteeZone", fields: [trusteeZoneId], references: [id])
  votes             Vote[]

  @@index([voterId])
  @@index([region])
  @@index([hasVoted])
  @@index([zoneId])
  @@index([yuvaPankZoneId])
  @@index([karobariZoneId])
  @@index([trusteeZoneId])
  @@index([lastLoginAt])
  @@index([isActive])
  @@map("voters")
}

model YuvaPankhCandidate {
  id                   String   @id @default(cuid())
  userId               String?
  name                 String
  email                String?
  phone                String?
  party                String?
  manifesto            String?
  status               String   @default("PENDING")
  rejectionReason      String?
  region               String
  position             String
  experience           String?
  education            String?
  zoneId               String?
  isOnlineRegistration Boolean  @default(true)
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  votes                Vote[]
  user                 User?    @relation(fields: [userId], references: [id], onDelete: Cascade)
  zone                 Zone?    @relation(fields: [zoneId], references: [id])

  @@index([status])
  @@index([region])
  @@index([position])
  @@index([zoneId])
  @@index([createdAt])
  @@index([userId])
  @@map("yuva_pankh_candidates")
}

model DeletedYuvaPankhCandidate {
  id                   String   @id @default(cuid())
  originalId           String   // Original candidate ID before deletion
  userId               String?
  name                 String
  email                String?
  phone                String?
  party                String?
  manifesto            String?
  status               String
  rejectionReason      String?
  region               String
  position             String
  experience           String?
  education            String?
  zoneId               String?
  isOnlineRegistration Boolean
  originalCreatedAt    DateTime // When the candidate was originally created
  originalUpdatedAt    DateTime // When the candidate was last updated
  deletedAt            DateTime @default(now()) // When the candidate was withdrawn
  deletedBy            String?  // User ID who withdrew (if self-withdrawal)
  reason               String?  // Reason for withdrawal
  zone                 Zone?    @relation(fields: [zoneId], references: [id])

  @@index([originalId])
  @@index([userId])
  @@index([deletedAt])
  @@index([region])
  @@index([status])
  @@map("deleted_yuva_pankh_candidates")
}

model YuvaPankhNominee {
  id              String   @id @default(cuid())
  name            String
  email           String?
  phone           String?
  party           String?
  manifesto       String?
  status          String   @default("PENDING")
  rejectionReason String?
  region          String
  position        String
  experience      String?
  education       String?
  zoneId          String?
  isAdminUploaded Boolean  @default(true)
  uploadedBy      String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  votes           Vote[]
  zone            Zone?    @relation(fields: [zoneId], references: [id])

  @@index([status])
  @@index([region])
  @@index([position])
  @@index([zoneId])
  @@index([createdAt])
  @@index([uploadedBy])
  @@map("yuva_pankh_nominees")
}

model KarobariCandidate {
  id                   String   @id @default(cuid())
  userId               String?
  name                 String
  email                String?
  phone                String?
  party                String?
  manifesto            String?
  status               String   @default("PENDING")
  rejectionReason      String?
  region               String
  position             String
  experience           String?
  education            String?
  zoneId               String?
  isOnlineRegistration Boolean  @default(true)
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  user                 User?    @relation(fields: [userId], references: [id], onDelete: Cascade)
  zone                 Zone?    @relation(fields: [zoneId], references: [id])
  votes                Vote[]

  @@index([status])
  @@index([region])
  @@index([position])
  @@index([zoneId])
  @@index([createdAt])
  @@index([userId])
  @@map("karobari_candidates")
}

model TrusteeCandidate {
  id                   String   @id @default(cuid())
  userId               String?
  name                 String
  nameGujarati         String?
  email                String?
  phone                String?
  party                String?
  manifesto            String?
  status               String   @default("PENDING")
  rejectionReason      String?
  region               String
  position             String
  experience           String?
  education            String?
  zoneId               String?
  seat                 String?
  isOnlineRegistration Boolean  @default(true)
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  user                 User?    @relation(fields: [userId], references: [id], onDelete: Cascade)
  zone                 Zone?    @relation(fields: [zoneId], references: [id])
  votes                Vote[]

  @@index([status])
  @@index([region])
  @@index([position])
  @@index([zoneId])
  @@index([seat])
  @@index([createdAt])
  @@index([userId])
  @@map("trustee_candidates")
}

model Election {
  id                    String   @id @default(cuid())
  title                 String
  description           String?
  type                  String
  startDate             DateTime
  endDate               DateTime
  status                String   @default("UPCOMING")
  isOnlineNomination    Boolean  @default(true)
  voterMinAge           Int?
  voterMaxAge           Int?
  candidateMinAge       Int?
  candidateMaxAge       Int?
  voterJurisdiction     String   @default("LOCAL")
  candidateJurisdiction String   @default("LOCAL")
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  votes                 Vote[]

  @@index([type])
  @@index([status])
  @@index([startDate])
  @@index([endDate])
  @@index([createdAt])
  @@map("elections")
}

model Vote {
  id                   String              @id @default(cuid())
  voterId              String
  timestamp            DateTime            @default(now())
  ipAddress            String?
  userAgent            String?
  latitude             Float?
  longitude            Float?
  karobariCandidateId  String?
  trusteeCandidateId   String?
  yuvaPankhCandidateId String?
  yuvaPankhNomineeId   String?
  electionId           String
  election             Election            @relation(fields: [electionId], references: [id], onDelete: Cascade)
  karobariCandidate    KarobariCandidate?  @relation(fields: [karobariCandidateId], references: [id], onDelete: Cascade)
  trusteeCandidate     TrusteeCandidate?   @relation(fields: [trusteeCandidateId], references: [id], onDelete: Cascade)
  voter                Voter               @relation(fields: [voterId], references: [id], onDelete: Cascade)
  yuvaPankhCandidate   YuvaPankhCandidate? @relation(fields: [yuvaPankhCandidateId], references: [id], onDelete: Cascade)
  yuvaPankhNominee     YuvaPankhNominee?   @relation(fields: [yuvaPankhNomineeId], references: [id], onDelete: Cascade)

  @@unique([voterId, electionId, trusteeCandidateId])
  @@index([voterId])
  @@index([electionId])
  @@index([yuvaPankhCandidateId])
  @@index([yuvaPankhNomineeId])
  @@index([karobariCandidateId])
  @@index([trusteeCandidateId])
  @@index([timestamp])
  @@map("votes")
}

model OTP {
  id        String   @id @default(cuid())
  phone     String
  code      String
  expiresAt DateTime
  isUsed    Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([phone])
  @@index([expiresAt])
  @@index([isUsed])
  @@index([createdAt])
  @@map("otps")
}

model Zone {
  id                  String               @id @default(cuid())
  code                String
  name                String
  nameGujarati        String
  description         String
  seats               Int
  electionType        String
  isActive            Boolean              @default(true)
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt
  karobariCandidates  KarobariCandidate[]
  trusteeCandidates   TrusteeCandidate[]
  voters              Voter[]
  yuvaPankVoters      Voter[]              @relation("VoterYuvaPankZone")
  karobariVoters      Voter[]              @relation("VoterKarobariZone")
  trusteeVoters       Voter[]              @relation("VoterTrusteeZone")
  yuvaPankhCandidates YuvaPankhCandidate[]
  yuvaPankhNominees   YuvaPankhNominee[]
  deletedYuvaPankhCandidates DeletedYuvaPankhCandidate[]

  @@unique([code, electionType])
  @@index([code])
  @@index([electionType])
  @@index([isActive])
  @@index([createdAt])
  @@map("zones")
}

model UploadedFile {
  id          String   @id @default(cuid())
  userId      String
  fileName    String
  fileType    String   // 'aadhaar', 'photo', 'proposer_aadhaar'
  originalName String
  mimeType    String
  size        Int
  fileData    String   // Base64 encoded file data
  filePath    String   // Virtual file path
  uploadedAt  DateTime @default(now())
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([fileType])
  @@index([uploadedAt])
  @@map("uploaded_files")
}
